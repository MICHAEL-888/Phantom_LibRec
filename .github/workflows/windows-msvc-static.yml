name: windows-msvc-static

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:
  build:
    runs-on: windows-latest
    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_DEFAULT_TRIPLET: x64-windows-static
      VCPKG_DEFAULT_HOST_TRIPLET: x64-windows-static
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
    steps:
      - uses: actions/checkout@v4

      - name: Enable vcpkg binary cache
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: dd930e314f529c86d2703a60d5ea7dd6573d9e5a
          runVcpkgInstall: true
          vcpkgDirectory: ${{ env.VCPKG_ROOT }}

      - name: Configure
        run: >
          cmake -S . -B build
          -G "Visual Studio 17 2022"
          -A x64
          -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}\scripts\buildsystems\vcpkg.cmake
          -DCMAKE_MSVC_RUNTIME_LIBRARY="MultiThreaded$<$<CONFIG:Debug>:Debug>"
          -DVCPKG_LIBRARY_LINKAGE=static
          -DVCPKG_CRT_LINKAGE=static
          -DLIBREC_ENABLE_DEPS=ON

      - name: Build
        run: cmake --build build --config Release

      - name: Upload Release binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-msvc-static-binaries
          path: |
            build/**/Release/*.exe
            build/**/Release/*.lib

      - name: Fail if Release DLLs exist
        shell: pwsh
        run: |
          $dlls = Get-ChildItem -Recurse -Path build -Filter *.dll -ErrorAction SilentlyContinue
          if ($dlls.Count -gt 0) {
            Write-Host "Found DLLs (expected fully static build):"
            $dlls | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Upload Release PDBs
        uses: actions/upload-artifact@v4
        with:
          name: windows-msvc-static-pdbs
          path: build/**/Release/*.pdb
